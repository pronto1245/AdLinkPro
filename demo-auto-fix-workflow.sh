#!/bin/bash

# Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ auto-fix workflow
echo "ðŸŽ¬ Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ GitHub Actions Auto-fix Workflow"
echo "=================================================="

# Ð¡Ð¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… GitHub Actions
KOYEB_URL="https://central-matelda-pronto12-95b8129d.koyeb.app"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BRANCH_NAME="auto-fix/netlify-koyeb-${TIMESTAMP}"
COMMIT_SHA="demo-$(echo $RANDOM | md5sum | head -c 8)"

echo "ðŸ”§ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:"
echo "   Koyeb URL: ${KOYEB_URL}"
echo "   Ð’ÐµÑ‚ÐºÐ°: ${BRANCH_NAME}"
echo "   ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${COMMIT_SHA}"
echo ""

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ demo Ñ„Ð°Ð¹Ð»Ð¾Ð²
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ netlify.toml
cat > demo-netlify.toml << EOF
[build]
  command = "npm run build:client"
  publish = "client/dist"

[build.environment]
  NODE_VERSION = "18"

[[redirects]]
  from = "/api/*"
  to = "${KOYEB_URL}/api/:splat"
  status = 200
  force = true

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# Health check proxy
[[redirects]]
  from = "/api/health"
  to   = "${KOYEB_URL}/health"
  status = 200
  force  = true

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https: wss:; object-src 'none'; base-uri 'self'"

[[headers]]
  for = "*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "*.html"
  [headers.values]
    Cache-Control = "public, max-age=3600"

[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
EOF

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env.production
cat > demo-env.production << EOF
# === PRODUCTION ENVIRONMENT CONFIGURATION ===
# Auto-generated by GitHub Actions - DO NOT EDIT MANUALLY

# React App Configuration
REACT_APP_API_URL=${KOYEB_URL}/api

# Environment
NODE_ENV=production

# === DEPLOYMENT INFO ===
# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
# Koyeb URL: ${KOYEB_URL}
# Branch: ${BRANCH_NAME}
# Commit: ${COMMIT_SHA}
EOF

echo "âœ… Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹!"
echo ""

echo "ðŸ“„ demo-netlify.toml:"
echo "----------------------"
cat demo-netlify.toml | head -15
echo "   ... (Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ Ñ„Ð°Ð¹Ð»Ð°) ..."
echo ""

echo "ðŸ“„ demo-env.production:"
echo "-----------------------"
cat demo-env.production
echo ""

echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾:"
echo "========================"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸
CHECKS_PASSED=0
TOTAL_CHECKS=6

echo -n "1. Netlify proxy Ð´Ð»Ñ API... "
if grep -q "${KOYEB_URL}/api/:splat" demo-netlify.toml; then
    echo "âœ… OK"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo "âŒ FAIL"
fi

echo -n "2. Netlify health check... "
if grep -q "${KOYEB_URL}/health" demo-netlify.toml; then
    echo "âœ… OK"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo "âŒ FAIL"
fi

echo -n "3. React API URL... "
if grep -q "REACT_APP_API_URL=${KOYEB_URL}/api" demo-env.production; then
    echo "âœ… OK"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo "âŒ FAIL"
fi

echo -n "4. Production environment... "
if grep -q "NODE_ENV=production" demo-env.production; then
    echo "âœ… OK"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo "âŒ FAIL"
fi

echo -n "5. Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸... "
if grep -q "X-Frame-Options" demo-netlify.toml && grep -q "Content-Security-Policy" demo-netlify.toml; then
    echo "âœ… OK"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo "âŒ FAIL"
fi

echo -n "6. ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÐºÐ¸... "
if grep -q "Cache-Control.*max-age=31536000" demo-netlify.toml; then
    echo "âœ… OK"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo "âŒ FAIL"
fi

echo ""
echo "ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ${CHECKS_PASSED}/${TOTAL_CHECKS} Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð¾"

if [ $CHECKS_PASSED -eq $TOTAL_CHECKS ]; then
    echo "ðŸŽ‰ Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹! Workflow Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ."
else
    echo "âš ï¸  ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹. Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð´Ð¾Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°."
fi

echo ""
echo "ðŸš€ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "=================="
echo "1. Ð—Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð² GitHub Actions"
echo "2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ 'Auto-fix Netlify + Koyeb Configuration'"
echo "3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Run workflow'"
echo "4. (ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Koyeb URL"
echo "5. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Run workflow' Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°"
echo ""
echo "ðŸ“‹ ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ workflow:"
echo "â€¢ Ð‘ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð²ÐµÑ‚ÐºÐ° ${BRANCH_NAME}"
echo "â€¢ Ð‘ÑƒÐ´ÑƒÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ netlify.toml Ð¸ .env.production"
echo "â€¢ Ð‘ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Pull Request Ð´Ð»Ñ review"
echo "â€¢ ÐŸÐ¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¶Ð° - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° Netlify"

# Cleanup
rm -f demo-netlify.toml demo-env.production

echo ""
echo "ðŸŽ¬ Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"