# Отчет по архитектуре данных дашборда владельца платформы

## Обзор источников данных

### 1. МЕТРИКИ (KPI Cards)

#### Активные партнеры
- **Источник**: `users` таблица
- **Запрос**: `SELECT COUNT(*) FROM users WHERE role = 'affiliate' AND is_active = true`
- **Endpoint**: `/api/admin/dashboard-metrics/:period`
- **Поле**: `activePartners`

#### Активные офферы
- **Источник**: `offers` таблица  
- **Запрос**: `SELECT COUNT(*) FROM offers WHERE status = 'active'`
- **Endpoint**: `/api/admin/dashboard-metrics/:period`
- **Поле**: `activeOffers`

#### Клики/Конверсии/Доходы
- **Источник**: `statistics` таблица
- **Запрос**: `SELECT SUM(clicks), SUM(conversions), SUM(revenue) FROM statistics`
- **Endpoint**: `/api/admin/dashboard-metrics/:period`
- **Поля**: `todayClicks`, `conversions`, `platformRevenue`

#### Фрод-показатель
- **Источник**: `fraud_alerts` таблица
- **Запрос**: `SELECT COUNT(*) FROM fraud_alerts`
- **Расчет**: `(fraudCount / totalClicks) * 100`

### 2. РАСЧЕТНЫЕ МЕТРИКИ

#### CR (Conversion Rate)
```sql
CR = (totalConversions / totalClicks) * 100
```
- **Источники**: statistics.conversions, statistics.clicks

#### EPC (Earnings Per Click)
```sql
EPC = totalRevenue / totalClicks
```
- **Источники**: statistics.revenue, statistics.clicks

#### ROI (Return on Investment)
```sql
ROI = (totalRevenue / 1000) * 100  // Примерная формула
```
- **Источники**: statistics.revenue

### 3. ГРАФИКИ И ДИАГРАММЫ

#### График трафика и конверсий
- **Источник**: `statistics` таблица
- **Endpoint**: `/api/admin/dashboard-chart/:period`
- **Данные**: clicks, leads, conversions, revenue по дням
- **Период**: Фильтрация по `statistics.date`

#### Гео-распределение
- **Источник**: `statistics` таблица
- **Endpoint**: `/api/admin/geo-distribution/:period`
- **Группировка**: `GROUP BY statistics.country`
- **Метрика**: `SUM(clicks)` по странам

### 4. АКТИВНОСТЬ И СОБЫТИЯ

#### Последние события
- **Источники**: `users`, `offers`, `tickets`, `fraud_alerts`
- **Endpoint**: `/api/admin/recent-activities`
- **Данные**:
  - Новые регистрации пользователей
  - Новые офферы
  - Новые тикеты поддержки
  - Фрод-алерты

### 5. БЫСТРЫЕ ДЕЙСТВИЯ

Навигационные ссылки на:
- Управление офферами
- Управление пользователями  
- Настройка постбеков
- Расширенная аналитика
- Детекция фрода
- Финансовые отчеты

## АКТУАЛЬНОЕ СОСТОЯНИЕ ДАННЫХ

### 1. Данные добавлены для тестирования
- ✅ Таблица `statistics` содержит 50 записей с тестовыми данными
- ✅ Созданы тестовые партнеры (role = 'affiliate') 
- ✅ Добавлены фрод-алерты для анализа (3 записи)
- ✅ Данные покрывают последние 7 дней для демонстрации

### 2. Проблемы выявленные при тестировании

### 2. Неточности в расчетах
- ⚠️ ROI формула упрощена и не отражает реальную рентабельность
- ⚠️ "Вчерашние клики" рассчитываются как 92% от общих кликов
- ⚠️ Отсутствует фильтрация по периодам в основных метриках

### 3. Fallback данные
- ⚠️ При ошибках SQL используются захардкоженные значения
- ⚠️ Графики показывают "No Data" вместо реальной статистики

### 4. Архитектурные проблемы
- ❌ Отсутствует связь между статистикой и реальными кликами
- ❌ Нет механизма автоматического создания статистических записей
- ❌ Фильтр по периодам не применяется ко всем запросам

## РЕКОМЕНДАЦИИ

### 1. Заполнение данных
- Создать механизм автоматического сбора статистики
- Добавить тестовые данные для демонстрации
- Реализовать трекинг реальных кликов

### 2. Улучшение метрик
- Исправить формулу ROI
- Добавить фильтрацию по периодам во все запросы
- Создать более точные расчеты CR и EPC

### 3. Система алертов
- Реализовать автоматические алерты по KPI
- Добавить уведомления о падении CR
- Создать систему мониторинга фрода

### 4. Резервное копирование
- Добавить логирование всех действий
- Создать механизм восстановления данных
- Реализовать кеширование критичных метрик

## СТАТУС КОМПОНЕНТОВ

✅ **Работает корректно:**
- Подсчет активных офферов
- Интернационализация
- Навигация и UI

⚠️ **Работает с ограничениями:**
- Метрики (используют fallback данные)
- Графики (показывают "No Data")
- Гео-распределение

❌ **Требует исправления:**
- Автоматическое создание статистики
- Реальные алерты и уведомления
- Точные расчеты ROI и метрик