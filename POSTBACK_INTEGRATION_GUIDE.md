# Postback Integration Guide

## –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Ç—Ä–µ–∫–µ—Ä–∞–º–∏

–î–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ —Ç—Ä–µ–∫–µ—Ä–∞–º–∏ –∞—Ñ—Ñ–∏–ª–µ–π—Ç-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, –≤–∫–ª—é—á–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–∫–∞—Ö –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—è—Ö.

## üéØ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç—Ä–µ–∫–µ—Ä—ã

### 1. Keitaro
```
URL: https://your-keitaro.com/api/v1/conversions?clickid={clickid}&status={status}&revenue={revenue}
–ú–µ—Ç–æ–¥: GET
```

### 2. Binom
```
URL: https://your-binom.com/click.php?cnv_id={clickid}&payout={revenue}
–ú–µ—Ç–æ–¥: GET
```

### 3. RedTrack
```
URL: https://your-redtrack.com/postback?clickid={clickid}&status={status}&sum={revenue}
–ú–µ—Ç–æ–¥: GET
```

### 4. Voluum
```
URL: https://your-voluum.com/postback?cid={clickid}&payout={revenue}
–ú–µ—Ç–æ–¥: GET
```

### 5. –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä
```
URL: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π URL —Å –º–∞–∫—Ä–æ—Å–∞–º–∏
–ú–µ—Ç–æ–¥: GET/POST
```

## üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã

| –ú–∞–∫—Ä–æ—Å | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|--------|----------|--------|
| `{clickid}` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–ª–∏–∫–∞ | test_exact_data |
| `{status}` | –°—Ç–∞—Ç—É—Å —Å–æ–±—ã—Ç–∏—è | lead, deposit, conversion |
| `{revenue}` | –î–æ—Ö–æ–¥ –æ—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ | 25.50 |
| `{currency}` | –í–∞–ª—é—Ç–∞ | USD, EUR |
| `{partner_id}` | ID –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | 04b06c87-c6cf-440f |
| `{offer_id}` | ID –æ—Ñ—Ñ–µ—Ä–∞ | 7b537e40-05bc-4e5b |
| `{sub1}` - `{sub16}` | SubID –ø–∞—Ä–∞–º–µ—Ç—Ä—ã | campaign_A, source_direct |
| `{country}` | –°—Ç—Ä–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | US, RU, DE |
| `{device}` | –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ | desktop, mobile, tablet |
| `{utm_source}` | UTM –∏—Å—Ç–æ—á–Ω–∏–∫ | google, facebook |
| `{utm_campaign}` | UTM –∫–∞–º–ø–∞–Ω–∏—è | summer2024 |

## üîß API Endpoints

### –†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–±–µ–∫–∞
```bash
POST /api/track/postback/send
{
  "clickid": "test_exact_data",
  "event_type": "lead",
  "revenue": "50.00",
  "currency": "USD",
  "txid": "tx_12345"
}
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–µ—Ä–∞
```bash
POST /api/track/postback/test
{
  "tracker_url": "https://httpbin.org/get?clickid={clickid}&status={status}&revenue={revenue}",
  "method": "GET",
  "test_data": {
    "clickid": "test123",
    "status": "lead",
    "revenue": "25.00"
  }
}
```

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### –ü—Ä–∏ –∫–ª–∏–∫–µ (lp_click)
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Å—Ç–±–µ–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ –ø–æ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π —Å—Å—ã–ª–∫–µ:
```javascript
{
  type: 'lp_click',
  clickId: 'unique_click_id',
  data: {
    clickid: 'unique_click_id',
    partner_id: 'partner_id',
    offer_id: 'offer_id',
    sub1: 'campaign_data',
    sub2: 'source_data',
    // ... –≤—Å–µ SubID –∏ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  }
}
```

### –ü—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö lead, deposit, conversion:
```javascript
{
  type: 'lead', // –∏–ª–∏ deposit, conversion
  clickId: 'original_click_id',
  data: {
    clickid: 'original_click_id',
    status: 'lead',
    revenue: '25.50',
    currency: 'USD',
    txid: 'transaction_id'
  }
}
```

## üéõÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ UI

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å—Ç–±–µ–∫–∞
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å—Ç–±–µ–∫–æ–≤"
2. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–±–µ–∫"
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—Ä–µ–∫–µ—Ä–∞ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ "–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π"
4. –í–≤–µ–¥–∏—Ç–µ URL —Å –º–∞–∫—Ä–æ—Å–∞–º–∏
5. –í—ã–±–µ—Ä–∏—Ç–µ HTTP –º–µ—Ç–æ–¥ (GET/POST)
6. –í–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –í –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–¢–µ—Å—Ç"
2. –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤–∞—à —Ç—Ä–µ–∫–µ—Ä
3. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
- –í–∫–ª–∞–¥–∫–∞ "–õ–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ (–∑–µ–ª–µ–Ω—ã–π = —É—Å–ø–µ—Ö, –∫—Ä–∞—Å–Ω—ã–π = –æ—à–∏–±–∫–∞)
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∏ –∫–æ–¥—ã HTTP —Å—Ç–∞—Ç—É—Å–æ–≤
- –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úÖ **–û—Ç–ø—Ä–∞–≤–ª–µ–Ω** - –ø–æ—Å—Ç–±–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
- ‚ùå **–û—à–∏–±–∫–∞** - –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
- ‚è≥ **–û–∂–∏–¥–∞–Ω–∏–µ** - –ø–æ—Å—Ç–±–µ–∫ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É

## üîÑ Retry –ª–æ–≥–∏–∫–∞

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏:
- –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ –ø–æ—Å—Ç–±–µ–∫
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- Timeout 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### PostbackService
```typescript
class PostbackService {
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å—Ç–±–µ–∫–æ–≤ –¥–ª—è —Å–æ–±—ã—Ç–∏—è
  static async triggerPostbacks(event: PostbackEvent): Promise<PostbackResult[]>
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π —Ç—Ä–µ–∫–µ—Ä
  static async sendExternalTrackerPostback(url: string, event: PostbackEvent): Promise<PostbackResult>
  
  // –ó–∞–º–µ–Ω–∞ –º–∞–∫—Ä–æ—Å–æ–≤ –≤ URL
  static replaceMacros(template: string, data: Record<string, string>): string
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ tracking.ts
```typescript
// –ü—Ä–∏ –∫–ª–∏–∫–µ
const postbackEvent: PostbackEvent = {
  type: 'lp_click',
  clickId: clickid,
  data: { /* –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–∫–∞ */ }
};
PostbackService.triggerPostbacks(postbackEvent);

// –ü—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
const postbackEvent: PostbackEvent = {
  type: eventData.type,
  clickId: eventData.clickid,
  data: { /* –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ */ }
};
PostbackService.triggerPostbacks(postbackEvent);
```

## üìã –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keitaro
```
–ù–∞–∑–≤–∞–Ω–∏–µ: Main Keitaro Tracker
URL: https://tracker.example.com/api/v1/conversions?clickid={clickid}&status={status}&revenue={revenue}&offer_id={offer_id}&partner_id={partner_id}&sub1={sub1}&sub2={sub2}
–ú–µ—Ç–æ–¥: GET
–°–æ–±—ã—Ç–∏—è: lp_click, lead, deposit, conversion
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–∫–∞
curl -G "http://localhost:5000/api/track/click" \
  -d "offer_id=OFFER_ID" \
  -d "partner_id=PARTNER_ID" \
  -d "sub1=test_campaign" \
  -d "sub2=test_source"

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
curl -X POST "http://localhost:5000/api/track/event" \
  -H "Content-Type: application/json" \
  -d '{
    "clickid": "generated_click_id",
    "type": "lead",
    "revenue": 25.00,
    "currency": "USD"
  }'
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ UI: —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç –≤ –≤–∞—à —Ç—Ä–µ–∫–µ—Ä
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–µ—Ä–∞

## üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
3. **–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ç—Ä–µ–∫–µ—Ä–æ–≤
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–±–µ–∫ URL
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ü–æ—Å—Ç–±–µ–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫

## üîß –û—Ç–ª–∞–¥–∫–∞

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **–¢–∞–π–º–∞—É—Ç**: –£–≤–µ–ª–∏—á—å—Ç–µ timeout –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è
2. **–ù–µ–≤–µ—Ä–Ω—ã–π URL**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –º–∞–∫—Ä–æ—Å–æ–≤
3. **HTTP –æ—à–∏–±–∫–∏**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç—Ä–µ–∫–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
4. **–ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã

### –õ–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–ª–∏–∫–æ–≤
SELECT click_id, partner_id, sub_id_1, sub_id_2, sub_id_3 
FROM tracking_clicks 
ORDER BY created_at DESC LIMIT 10;

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–±–µ–∫ —à–∞–±–ª–æ–Ω–æ–≤
SELECT name, url, events, is_active 
FROM postback_templates 
WHERE is_active = true;
```

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –ª—é–±—ã–º–∏ –≤–Ω–µ—à–Ω–∏–º–∏ —Ç—Ä–µ–∫–µ—Ä–∞–º–∏.