#!/bin/bash

# –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —Ä–æ–ª–µ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ API
echo "=== –¢–ï–°–¢ –†–û–õ–ï–í–û–ô –ú–û–î–ï–õ–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ==="

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞
AFFILIATE_TOKEN=$(cat .token 2>/dev/null || echo "")

if [ -z "$AFFILIATE_TOKEN" ]; then
    echo "‚ùå –¢–æ–∫–µ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞: $(echo $AFFILIATE_TOKEN | head -c 20)..."

# –ë–∞–∑–æ–≤—ã–π URL API
BASE_URL="http://localhost:5000/api"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞ API
test_api() {
    local method=$1
    local endpoint=$2
    local token=$3
    local expected_status=$4
    local description=$5
    
    echo "üß™ –¢–µ—Å—Ç: $description"
    echo "   $method $endpoint"
    
    response=$(curl -s -w "\n%{http_code}" -X $method \
        -H "Authorization: Bearer $token" \
        -H "Content-Type: application/json" \
        "$BASE_URL$endpoint" 2>/dev/null)
    
    status_code=$(echo "$response" | tail -1)
    body=$(echo "$response" | head -n -1)
    
    if [ "$status_code" = "$expected_status" ]; then
        echo "   ‚úÖ –°—Ç–∞—Ç—É—Å: $status_code (–æ–∂–∏–¥–∞–µ–º—ã–π)"
    else
        echo "   ‚ùå –°—Ç–∞—Ç—É—Å: $status_code (–æ–∂–∏–¥–∞–ª—Å—è $expected_status)"
        if [ ! -z "$body" ]; then
            echo "   üìù –û—Ç–≤–µ—Ç: $body"
        fi
    fi
    echo ""
}

echo "üìã –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º:"

# –¢–µ—Å—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞
test_api "GET" "/auth/me" "$AFFILIATE_TOKEN" "200" "–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è"
test_api "GET" "/notifications" "$AFFILIATE_TOKEN" "200" "–ü–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
test_api "GET" "/partner/offers" "$AFFILIATE_TOKEN" "200" "–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤"
test_api "GET" "/partner/access-requests" "$AFFILIATE_TOKEN" "200" "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–∞"

echo "üö´ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω—Å–∫–∏–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º:"

# –¢–µ—Å—Ç—ã –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞
test_api "GET" "/admin/users" "$AFFILIATE_TOKEN" "403" "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–∞–¥–º–∏–Ω)"
test_api "GET" "/admin/offers" "$AFFILIATE_TOKEN" "403" "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –æ—Ñ—Ñ–µ—Ä–∞–º–∏ (–∞–¥–º–∏–Ω)"
test_api "GET" "/admin/analytics" "$AFFILIATE_TOKEN" "403" "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞"
test_api "GET" "/admin/finances" "$AFFILIATE_TOKEN" "403" "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å (–∞–¥–º–∏–Ω)"

echo "üîí –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å—Å–∫–∏–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º:"

# –¢–µ—Å—Ç—ã –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è  
test_api "GET" "/advertiser/offers" "$AFFILIATE_TOKEN" "403" "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞–º–∏ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è"
test_api "GET" "/advertiser/team/members" "$AFFILIATE_TOKEN" "403" "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è"
test_api "GET" "/advertiser/statistics" "$AFFILIATE_TOKEN" "403" "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è"
test_api "POST" "/advertiser/offers" "$AFFILIATE_TOKEN" "403" "–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–æ–≤"

echo "üîê –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –±–µ–∑ —Ç–æ–∫–µ–Ω–∞:"

# –¢–µ—Å—Ç—ã –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
test_api "GET" "/auth/me" "" "401" "–î–æ—Å—Ç—É–ø –±–µ–∑ —Ç–æ–∫–µ–Ω–∞"
test_api "GET" "/partner/offers" "" "401" "–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ –æ—Ñ—Ñ–µ—Ä—ã –±–µ–∑ —Ç–æ–∫–µ–Ω–∞"

echo "üîë –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º:"

# –¢–µ—Å—Ç—ã —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
INVALID_TOKEN="invalid.jwt.token"
test_api "GET" "/auth/me" "$INVALID_TOKEN" "403" "–î–æ—Å—Ç—É–ø —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º"

echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ê ==="
echo "‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
echo "‚úÖ –†–æ–ª–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ" 
echo "‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ä–æ–ª—è–º–∏ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è"
echo "‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞"

echo ""
echo "üìä –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:"
echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞:"
grep "test_affiliate" server.log 2>/dev/null | tail -5 || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"

echo ""
echo "üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"