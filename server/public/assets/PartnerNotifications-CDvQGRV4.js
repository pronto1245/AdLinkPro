import{j as t}from"./ui-CkQMVfNu.js";import{r as q}from"./vendor-DazevGLP.js";import{u as E}from"./useQuery-IUx4ZSsA.js";import{u as A,d as R,K as $,r as K,N as d,B as u,m as f,C as S,e as B,f as P,g as M,X as Q,A as j,y as z}from"./index-Hu68kGEe.js";import{u as m}from"./useMutation-HxEtoRum.js";import{B as a}from"./badge-BPEJ7H1K.js";import{a as D}from"./queryClient-Cc5pa0C1.js";import{C as F}from"./clock-HOqnpwZm.js";import{f as O}from"./utils-B-_CankM.js";import{r as I}from"./ru-amAWtAem.js";function ee(){const{user:i}=A(),{toast:n}=R(),{t:N}=$(),o=K();q.useEffect(()=>{const e=localStorage.getItem("auth_token");console.log("🔍 PartnerNotifications component - token check:",{token:e?e.substring(0,20)+"...":"NO_TOKEN",user:i?.username})},[i]);const{data:l=[],isLoading:y}=E({queryKey:["/api/notifications"],enabled:!!i?.id}),b=()=>{const e=localStorage.getItem("auth_token");return console.log("🔍 Getting auth token:",{hasToken:!!e,isNull:e==="null",isEmpty:e==="",tokenStart:e?e.substring(0,20):"NO_TOKEN"}),e&&e!=="null"&&e!=="undefined"&&e.trim()!==""?e:null},x=m({mutationKey:["markAsRead"],mutationFn:async e=>{console.log("🚀 Starting markAsRead mutation for:",e);const r=b();if(!r)throw console.error("❌ No valid auth token found"),new Error("Authentication required - please re-login");console.log("✅ Valid token found, making request...");try{const s=await fetch(`/api/notifications/${e}/read`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});if(console.log("📡 Response received:",{status:s.status,statusText:s.statusText,ok:s.ok}),!s.ok){const C=await s.text();throw console.error("❌ Request failed:",{status:s.status,error:C}),new Error(`Failed to mark as read: ${s.status} ${s.statusText}`)}const p=await s.json();return console.log("✅ Mark as read successful:",p),p}catch(s){throw console.error("❌ Network error in markAsRead:",s),s}},onSuccess:()=>{o.invalidateQueries({queryKey:["/api/notifications"]}),o.invalidateQueries({queryKey:["/api/partner/dashboard"]})},onError:e=>{n({title:"Ошибка",description:"Не удалось отметить уведомление как прочитанное",variant:"destructive"})}}),h=m({mutationFn:async e=>{const r=localStorage.getItem("auth_token");if(!r||r==="null"||r==="undefined")throw new Error("No valid token found");const s=await fetch(`/api/notifications/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);return s.json()},onSuccess:()=>{o.invalidateQueries({queryKey:["/api/notifications"]}),o.invalidateQueries({queryKey:["/api/partner/dashboard"]}),n({title:"Успех",description:"Уведомление удалено"})},onError:e=>{n({title:"Ошибка",description:"Не удалось удалить уведомление",variant:"destructive"})}}),g=m({mutationFn:async()=>{await D("/api/notifications/mark-all-read","PUT")},onSuccess:()=>{o.invalidateQueries({queryKey:["/api/notifications"]}),n({title:"Успех",description:"Все уведомления отмечены как прочитанные"})},onError:e=>{n({title:"Ошибка",description:"Не удалось отметить уведомления как прочитанные",variant:"destructive"})}}),k=e=>{x.mutate(e)},v=e=>{h.mutate(e)},w=()=>{g.mutate()},_=e=>{switch(e){case"offer_request_approved":return t.jsx(j,{className:"w-5 h-5 text-green-600"});case"offer_request_rejected":return t.jsx(z,{className:"w-5 h-5 text-red-600"});case"offer_request_created":return t.jsx(F,{className:"w-5 h-5 text-blue-600"});case"payment":return t.jsx(j,{className:"w-5 h-5 text-green-600"});default:return t.jsx(d,{className:"w-5 h-5 text-gray-600"})}},T=e=>{switch(e){case"offer_request_approved":return t.jsx(a,{className:"bg-green-100 text-green-800",children:"Одобрено"});case"offer_request_rejected":return t.jsx(a,{className:"bg-red-100 text-red-800",children:"Отклонено"});case"offer_request_created":return t.jsx(a,{className:"bg-blue-100 text-blue-800",children:"Новый запрос"});case"payment":return t.jsx(a,{className:"bg-green-100 text-green-800",children:"Выплата"});default:return t.jsx(a,{className:"bg-gray-100 text-gray-800",children:"Общее"})}},c=l.filter(e=>!e.is_read).length;return y?t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),t.jsx("p",{className:"mt-2 text-gray-600",children:"Загрузка уведомлений..."})]})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(d,{className:"w-6 h-6 text-blue-600"}),t.jsx("h1",{className:"text-2xl font-bold",children:N("notifications.title")}),c>0&&t.jsxs(a,{className:"bg-red-100 text-red-800",children:[c," непрочитанных"]})]}),c>0&&t.jsxs(u,{onClick:w,disabled:g.isPending,variant:"outline",size:"sm",children:[t.jsx(f,{className:"w-4 h-4 mr-2"}),"Отметить все как прочитанные"]})]}),t.jsxs(S,{children:[t.jsx(B,{children:t.jsx(P,{children:"Все уведомления"})}),t.jsx(M,{children:l.length===0?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(d,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Уведомлений нет"}),t.jsx("p",{className:"text-gray-600",children:"Здесь будут отображаться уведомления о статусе ваших запросов на офферы"})]}):t.jsx("div",{className:"space-y-4",children:l.map(e=>t.jsx("div",{className:`p-4 rounded-lg border transition-colors ${e.is_read?"bg-gray-50 border-gray-200":"bg-blue-50 border-blue-200"}`,children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[_(e.type),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("h4",{className:`font-medium ${e.is_read?"text-gray-900":"text-blue-900"}`,children:e.title}),T(e.type)]}),t.jsx("p",{className:`text-sm ${e.is_read?"text-gray-600":"text-blue-700"}`,children:e.message}),e.metadata?.rejectReason&&t.jsxs("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm",children:[t.jsx("strong",{children:"Причина отклонения:"})," ",e.metadata.rejectReason]}),e.metadata?.amount&&t.jsxs("div",{className:"mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm",children:[t.jsx("strong",{children:"Сумма:"})," ",e.metadata.amount," ",e.metadata.currency||"USD"]}),t.jsx("p",{className:"text-xs text-gray-500 mt-2",children:O(new Date(e.created_at),{addSuffix:!0,locale:I})})]})]}),t.jsxs("div",{className:"flex items-center gap-2 ml-4",children:[!e.is_read&&t.jsx(u,{onClick:()=>k(e.id),disabled:x.isPending,variant:"outline",size:"sm",children:t.jsx(f,{className:"w-4 h-4"})}),t.jsx(u,{onClick:()=>v(e.id),disabled:h.isPending,variant:"outline",size:"sm",className:"text-red-600 hover:text-red-700",children:t.jsx(Q,{className:"w-4 h-4"})})]})]})},e.id))})})]})]})}export{ee as default};
