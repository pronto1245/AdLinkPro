# Модуль "Партнёрская Команда" - Подробное руководство

## Обзор системы

Модуль партнёрской команды позволяет партнёрам (affiliates) создавать собственные команды сотрудников с разными ролями и разрешениями. Каждый участник команды получает доступ к офферам партнёра и может работать с трафиком под своим уникальным идентификатором.

## Архитектура системы

### База данных
```sql
-- Таблица команды партнёра
CREATE TABLE partner_team (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  partner_id VARCHAR NOT NULL REFERENCES users(id),
  user_id VARCHAR NOT NULL REFERENCES users(id),
  role TEXT NOT NULL, -- 'buyer', 'analyst', 'manager'
  permissions JSONB NOT NULL, -- массив разрешений
  sub_id_prefix TEXT, -- уникальный префикс для SubID
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### API эндпоинты
- `GET /api/affiliate/team` - получить список участников команды
- `POST /api/affiliate/team` - добавить нового участника
- `PATCH /api/affiliate/team/:id` - обновить участника
- `DELETE /api/affiliate/team/:id` - удалить участника

## Роли в команде

### 1. Buyer (Байер)
**Описание:** Основной сотрудник, который работает с трафиком
**Разрешения по умолчанию:**
- `view_offers` - просмотр доступных офферов
- `generate_links` - создание трекинговых ссылок
- `view_statistics` - просмотр статистики
- `manage_creatives` - работа с креативами

### 2. Analyst (Аналитик)
**Описание:** Сотрудник для анализа данных и оптимизации
**Разрешения по умолчанию:**
- `view_offers` - просмотр офферов
- `view_statistics` - расширенная статистика
- `view_analytics` - доступ к аналитике
- `export_data` - экспорт данных

### 3. Manager (Менеджер)
**Описание:** Руководящая роль с расширенными правами
**Разрешения по умолчанию:**
- `view_offers` - просмотр офферов
- `generate_links` - создание ссылок
- `view_statistics` - полная статистика
- `manage_creatives` - управление креативами
- `view_analytics` - аналитика
- `export_data` - экспорт данных
- `manage_team_settings` - управление настройками команды

## Процесс добавления участника

### 1. Инициация создания
Партнёр открывает страницу `/affiliate/team` и нажимает "Добавить участника"

### 2. Заполнение формы
```typescript
interface CreateTeamMemberData {
  email: string;           // Email нового участника
  username: string;        // Уникальное имя пользователя
  password: string;        // Пароль для входа
  role: 'buyer' | 'analyst' | 'manager';
  permissions: string[];   // Массив разрешений
  subIdPrefix?: string;    // Префикс для SubID (опционально)
}
```

### 3. Создание в системе
При отправке формы происходит:

1. **Проверка уникальности** - система проверяет, что email и username не заняты
2. **Создание пользователя** - создаётся новый user в таблице users:
   ```sql
   INSERT INTO users (
     username, email, password, role, owner_id, advertiser_id,
     is_active, user_type, settings
   ) VALUES (
     'buyer1_test', 'buyer1@example.com', 'hashed_password', 'affiliate',
     'partner_id', 'inherited_advertiser_id', true, 'team_member',
     '{"teamRole": "buyer", "permissions": [...], "isTeamMember": true}'
   );
   ```

3. **Добавление в команду** - создаётся запись в partner_team:
   ```sql
   INSERT INTO partner_team (
     partner_id, user_id, role, permissions, sub_id_prefix, is_active
   ) VALUES (
     'partner_id', 'new_user_id', 'buyer', 
     '["view_offers", "generate_links", "view_statistics"]', 'B1', true
   );
   ```

4. **Наследование доступа** - участник автоматически получает доступ ко всем офферам партнёра:
   ```sql
   INSERT INTO partner_offers (
     partner_id, offer_id, is_approved, assigned_at, assigned_by, status
   ) SELECT 
     'new_user_id', offer_id, true, NOW(), 'partner_id', 'active'
   FROM partner_offers 
   WHERE partner_id = 'partner_id' AND is_approved = true;
   ```

## Как участник попадает на сайт

### 1. Получение учётных данных
Участник получает от партнёра:
- **Username:** buyer_demo
- **Password:** demo123  
- **URL:** https://your-platform.com/login

### Примеры созданных участников команды:
- **Buyer Demo**: username=`buyer_demo`, role=`buyer`, SubID prefix=`DEMO`
- **Analyst Demo**: username=`analyst_demo`, role=`analyst`, SubID prefix=`A1`

### 2. Авторизация
Участник заходит на страницу `/login` и вводит свои данные

### 3. Определение роли и доступа
После успешной авторизации система:
1. Проверяет роль пользователя (`affiliate`)
2. Определяет, что это участник команды (`user_type: 'team_member'`)
3. Загружает настройки из поля `settings`
4. Перенаправляет на интерфейс партнёра

### 4. Интерфейс участника команды
Участник видит тот же интерфейс партнёра, но с ограничениями согласно разрешениям:

#### Доступные разделы:
- **Дашборд** - статистика по своему трафику
- **Офферы** - только офферы, к которым есть доступ
- **Ссылки** - генерация ссылок с уникальным SubID префиксом
- **Креативы** - скачивание материалов
- **Статистика** - аналитика по своему трафику

#### Ограничения по разрешениям:
```typescript
// Пример проверки разрешений в компонентах
if (user.settings?.permissions?.includes('view_statistics')) {
  // Показать раздел статистики
}

if (user.settings?.permissions?.includes('generate_links')) {
  // Показать кнопку генерации ссылок
}
```

## Уникальная идентификация трафика

### SubID префиксы
Каждый участник команды получает уникальный префикс для SubID:
- **Партнёр:** основные ссылки без префикса
- **Buyer1:** префикс "B1" → субид "B1_campaign_name"
- **Analyst1:** префикс "A1" → субид "A1_test_traffic"
- **Manager1:** префикс "M1" → субид "M1_premium_source"

### Трекинг ссылки
При генерации ссылки система автоматически добавляет префикс:
```
https://arbiconnect.store/track/casino_gold_B1?subid=B1_facebook_ads&sub2=premium
```

### Отчётность
В статистике партнёр видит:
- Общий трафик команды
- Разбивку по участникам через SubID префиксы
- Эффективность каждого байера/аналитика

## Безопасность и изоляция

### Доступ к данным
- Участники команды видят только свою статистику
- Доступ к офферам наследуется от партнёра
- Изменения в команде может делать только владелец (партнёр)

### Права доступа
- **Создание участников:** только партнёр
- **Изменение ролей:** только партнёр  
- **Деактивация:** партнёр или супер-админ
- **Просмотр команды:** только участники этой команды

## Технические детали

### Frontend компоненты
- `TeamManagement.tsx` - основной компонент управления командой
- Использует React Query для управления состоянием
- Модальные окна для создания/редактирования участников
- Таблица с фильтрацией и сортировкой

### Backend логика
- Middleware проверки ролей и разрешений
- Автоматическое наследование доступа к офферам
- Soft delete для безопасного удаления участников
- Логирование всех операций с командой

### База данных
- Связь через foreign keys для целостности данных
- JSON поля для гибкого хранения разрешений
- Индексы для быстрого поиска по partner_id
- Временные метки для аудита изменений

## Мониторинг и аналитика

Система автоматически отслеживает:
- Активность участников команды
- Генерацию ссылок с префиксами
- Конверсии по каждому участнику
- Статистику эффективности команды

Все данные доступны партнёру в разделе аналитики с детализацией по участникам.

## Тестирование системы

### Успешно протестированные функции:
✅ **Создание участников команды** - API `/api/affiliate/team` POST  
✅ **Получение списка команды** - API `/api/affiliate/team` GET  
✅ **Роли и разрешения** - buyer, analyst, manager с настраиваемыми правами  
✅ **SubID префиксы** - уникальные идентификаторы для каждого участника  
✅ **Наследование доступа** - автоматический доступ к офферам партнёра  
✅ **База данных** - корректное сохранение в partner_team и users таблицы  

### Текущий статус:
- **API эндпоинты:** ✅ Полностью функциональны
- **База данных:** ✅ Схема настроена корректно
- **Аутентификация:** ✅ JWT токены работают
- **Валидация:** ✅ Проверка уникальности email/username
- **Безопасность:** ✅ Изоляция данных по партнёрам

### Финальное тестирование CRUD операций:
✅ **CREATE** - Создание участника test_buyer с ролью buyer  
✅ **READ** - Получение списка команды через GET /api/affiliate/team  
✅ **UPDATE** - Изменение роли buyer → manager и обновление permissions  
✅ **DELETE** - Soft delete с фильтрацией неактивных участников  

### Готовые функции:
✅ **Frontend интерфейс** - TeamManagement.tsx работает с реальными API
✅ **API эндпоинты** - полный CRUD для управления командой
✅ **Валидация данных** - проверка уникальности email/username
✅ **Безопасность** - изоляция данных по партнёрам, JWT аутентификация
✅ **Soft delete** - безопасное удаление с сохранением истории