<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Module Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        input, button { margin: 5px; padding: 8px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Authorization Module Test</h1>
        
        <div class="test-section">
            <h3>1. Login Test</h3>
            <input type="text" id="username" placeholder="Username" value="owner">
            <input type="password" id="password" placeholder="Password" value="owner123">
            <button onclick="testLogin()">Test Login</button>
            <div id="loginResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. 2FA Test</h3>
            <input type="text" id="username2fa" placeholder="Username" value="advertiser">
            <input type="password" id="password2fa" placeholder="Password" value="adv123">
            <button onclick="test2FA()">Test 2FA Login</button>
            <br>
            <input type="text" id="twoFactorCode" placeholder="2FA Code" value="123456">
            <button onclick="verify2FA()" id="verify2FABtn" disabled>Verify 2FA</button>
            <div id="twoFAResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Password Recovery Test</h3>
            <input type="email" id="recoveryEmail" placeholder="Email" value="9791207@gmail.com">
            <button onclick="testPasswordRecovery()">Test Password Recovery</button>
            <div id="recoveryResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Protected Endpoint Test</h3>
            <button onclick="testProtectedEndpoint()">Test Protected Endpoint</button>
            <div id="protectedResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. Role-Based Access Test</h3>
            <button onclick="testRoleAccess()">Test Role-based Access</button>
            <div id="roleResult" class="result"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let tempToken = null;

        async function apiCall(endpoint, method = 'GET', body = null, useAuth = false) {
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (useAuth && currentToken) {
                    headers['Authorization'] = `Bearer ${currentToken}`;
                }

                const response = await fetch(endpoint, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });

                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const result = await apiCall('/api/auth/v2/login', 'POST', { username, password });
            
            if (result.success && result.data.token) {
                currentToken = result.data.token;
                document.getElementById('loginResult').textContent = 
                    `✅ Login successful!\nToken: ${result.data.token.substring(0, 50)}...\nUser: ${JSON.stringify(result.data.user, null, 2)}`;
                document.getElementById('loginResult').parentElement.className = 'test-section success';
            } else {
                document.getElementById('loginResult').textContent = 
                    `❌ Login failed:\n${JSON.stringify(result, null, 2)}`;
                document.getElementById('loginResult').parentElement.className = 'test-section error';
            }
        }

        async function test2FA() {
            const username = document.getElementById('username2fa').value;
            const password = document.getElementById('password2fa').value;
            
            const result = await apiCall('/api/auth/v2/login', 'POST', { username, password });
            
            if (result.success && result.data.requires2FA) {
                tempToken = result.data.tempToken;
                document.getElementById('verify2FABtn').disabled = false;
                document.getElementById('twoFAResult').textContent = 
                    `⚠️ 2FA required!\nTemp token: ${result.data.tempToken.substring(0, 20)}...\nEnter 2FA code and click Verify`;
                document.getElementById('twoFAResult').parentElement.className = 'test-section warning';
            } else {
                document.getElementById('twoFAResult').textContent = 
                    `Result:\n${JSON.stringify(result, null, 2)}`;
            }
        }

        async function verify2FA() {
            if (!tempToken) {
                alert('Please run 2FA test first');
                return;
            }

            const code = document.getElementById('twoFactorCode').value;
            const result = await apiCall('/api/auth/v2/verify-2fa', 'POST', { token: tempToken, code });
            
            if (result.success && result.data.token) {
                currentToken = result.data.token;
                document.getElementById('twoFAResult').textContent = 
                    `✅ 2FA verification successful!\nToken: ${result.data.token.substring(0, 50)}...\nUser: ${JSON.stringify(result.data.user, null, 2)}`;
                document.getElementById('twoFAResult').parentElement.className = 'test-section success';
            } else {
                document.getElementById('twoFAResult').textContent = 
                    `❌ 2FA verification failed:\n${JSON.stringify(result, null, 2)}`;
                document.getElementById('twoFAResult').parentElement.className = 'test-section error';
            }
        }

        async function testPasswordRecovery() {
            const email = document.getElementById('recoveryEmail').value;
            
            const result = await apiCall('/api/auth/v2/reset-password', 'POST', { email });
            
            if (result.success) {
                document.getElementById('recoveryResult').textContent = 
                    `✅ Password recovery initiated!\n${JSON.stringify(result.data, null, 2)}`;
                document.getElementById('recoveryResult').parentElement.className = 'test-section success';
            } else {
                document.getElementById('recoveryResult').textContent = 
                    `❌ Password recovery failed:\n${JSON.stringify(result, null, 2)}`;
                document.getElementById('recoveryResult').parentElement.className = 'test-section error';
            }
        }

        async function testProtectedEndpoint() {
            if (!currentToken) {
                document.getElementById('protectedResult').textContent = '❌ Please login first to get a token';
                return;
            }

            // Test public endpoint first
            const publicResult = await apiCall('/api/partner/offers', 'GET', null, true);
            
            document.getElementById('protectedResult').textContent = 
                `Protected endpoint test:\n${JSON.stringify(publicResult, null, 2)}`;
            
            if (publicResult.success) {
                document.getElementById('protectedResult').parentElement.className = 'test-section success';
            } else {
                document.getElementById('protectedResult').parentElement.className = 'test-section error';
            }
        }

        async function testRoleAccess() {
            if (!currentToken) {
                document.getElementById('roleResult').textContent = '❌ Please login first to get a token';
                return;
            }

            const tests = [
                { endpoint: '/api/partner/offers', role: 'Partner endpoint' },
                { endpoint: '/api/partner/dashboard', role: 'Partner dashboard' },
                { endpoint: '/api/partner/finance/summary', role: 'Partner finance' }
            ];

            let results = [];
            for (const test of tests) {
                const result = await apiCall(test.endpoint, 'GET', null, true);
                results.push({
                    endpoint: test.role,
                    status: result.status,
                    success: result.success,
                    data: result.success ? 'OK' : result.data?.error || 'Failed'
                });
            }

            document.getElementById('roleResult').textContent = 
                `Role-based access test results:\n${JSON.stringify(results, null, 2)}`;
            
            const allSuccessful = results.every(r => r.success);
            document.getElementById('roleResult').parentElement.className = 
                allSuccessful ? 'test-section success' : 'test-section warning';
        }

        // Auto-run some tests on page load
        window.onload = function() {
            console.log('Auth test page loaded');
        };
    </script>
</body>
</html>