# Отчет об интеграции антифрод системы с реальными данными

## Статус интеграции: ✅ ЗАВЕРШЕНА

### Что было реализовано:

#### 1. Интеграция с базой данных
✅ **Реальные данные кликов**: Антифрод система теперь анализирует данные из таблицы `tracking_clicks`
✅ **Связь с партнерами и офферами**: Показывает реальные имена партнеров и офферов
✅ **Временные фильтры**: Поддержка фильтров по дням (24h, 7d, 30d)

#### 2. Аналитика фрода
✅ **Расчет реального fraud rate**: На основе полей `is_fraud` и `risk_score` из БД
✅ **Группировка по типам**: Анализ `fraud_reason` для статистики типов фрода
✅ **Топ мошеннических партнеров**: Ранжирование по проценту фрода
✅ **Статистика по странам**: Реальные данные по странам из кликов
✅ **Почасовая статистика**: Распределение событий фрода по часам

#### 3. API endpoints
✅ **GET /api/advertiser/antifraud/dashboard**: Дашборд с реальными данными
✅ **GET /api/advertiser/antifraud/events**: Фильтрация событий фрода 
✅ **POST /api/advertiser/antifraud/blacklist**: Добавление IP в черный список
✅ **GET/POST /api/advertiser/antifraud/settings**: Управление настройками

### Доступные фильтры в системе:

#### Фильтры событий антифрода:
- **Тип фрода**: bot, vpn, proxy, duplicate, suspicious_cr, click_spam, tor
- **Партнер**: Фильтр по конкретному партнеру
- **Оффер**: Фильтр по конкретному офферу  
- **Уровень риска**: high (80+), medium (50-79), low (<50)
- **Статус**: blocked (is_fraud=true), flagged (risk_score>70)
- **Даты**: Диапазон дат для анализа

#### Примеры SQL запросов:
```sql
-- Получение всех событий фрода за последние 30 дней
SELECT tc.*, u.username as partner_name, o.name as offer_name
FROM tracking_clicks tc
LEFT JOIN users u ON u.id = tc.partner_id  
LEFT JOIN offers o ON o.id = tc.offer_id
WHERE tc.created_at >= NOW() - INTERVAL '30 days'
AND (tc.is_fraud = true OR tc.risk_score > 70)

-- Статистика по партнерам с высоким fraud rate
SELECT 
  tc.partner_id,
  u.username,
  COUNT(*) as total_clicks,
  SUM(CASE WHEN tc.is_fraud OR tc.risk_score > 70 THEN 1 ELSE 0 END) as fraud_clicks,
  (SUM(CASE WHEN tc.is_fraud OR tc.risk_score > 70 THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) as fraud_rate
FROM tracking_clicks tc
LEFT JOIN users u ON u.id = tc.partner_id
GROUP BY tc.partner_id, u.username
HAVING fraud_rate > 20
ORDER BY fraud_rate DESC
```

### Логика определения фрода:

#### Критерии фрода:
1. **is_fraud = true**: Подтвержденный фрод
2. **risk_score > 70**: Подозрительная активность  
3. **fraud_reason**: Причина блокировки (bot, vpn, proxy и т.д.)

#### Автоматические проверки:
- **Бот-детекция**: Проверка JavaScript, headless браузеры
- **VPN/Proxy**: Обнаружение анонимайзеров
- **Click spam**: Лимиты кликов с одного IP
- **Suspicious CR**: Аномально высокий conversion rate
- **Geo-фильтрация**: Блокировка по странам

### Связь со статистикой:

#### Интеграция с analytics:
✅ **Общие клики**: Антифрод использует те же данные что и аналитика
✅ **SubID сохранение**: Фрод события сохраняют все SubID параметры
✅ **Партнерская привязка**: Точная идентификация партнера для каждого события
✅ **Связь с офферами**: Фрод статистика привязана к конкретным офферам

#### Влияние на статистику:
- **Заблокированные клики** (is_fraud=true) исключаются из основной статистики
- **Подозрительные клики** (risk_score>70) помечаются, но остаются в статистике
- **Fraud rate** рассчитывается как % заблокированного трафика

### Настройки антифрода:

#### Доступные параметры:
- **Чувствительность**: 1-10 (влияет на risk_score)
- **Автоблокировка**: Автоматическая блокировка при высоком риске
- **Бот-детекция**: Включение/отключение проверок ботов
- **VPN детекция**: Блокировка VPN/proxy трафика
- **Click spam**: Лимиты кликов с IP в минуту
- **Уведомления**: Email/Telegram при превышении порога

### Мониторинг и отчеты:

#### Реальные метрики:
- **Общее количество событий**: Из реальных кликов в БД
- **Заблокированные события**: По условию is_fraud=true
- **Fraud rate**: Реальный процент заблокированного трафика
- **Топ источники фрода**: Ранжирование партнеров по fraud rate
- **География фрода**: Анализ по странам из реальных данных

### Выводы:

✅ **Система полностью интегрирована** с реальными данными из базы
✅ **Нет mock данных** - все показатели рассчитываются из tracking_clicks
✅ **Связь со статистикой** - общий источник данных для аналитики и антифрода
✅ **Автоматическое обнаружение** - алгоритмы анализа в реальном времени
✅ **Настраиваемые правила** - гибкие параметры для каждого рекламодателя

Антифрод система готова к продуктивному использованию и дает точные данные на основе реального трафика.