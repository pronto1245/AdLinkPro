# Universal Sidebar Implementation Documentation

## Обзор

В рамках технического задания было реализовано полнофункциональное левое меню (Universal Sidebar) для платформы AdLinkPro с поддержкой ролей "Партнер" и "Рекламодатель". Реализация включает все требуемые компоненты: интеграцию с API, обработку токенов, роль-ориентированную навигацию и адаптивный дизайн.

## Архитектура компонентов

### 1. UniversalSidebar.tsx
**Местоположение**: `client/src/components/layout/UniversalSidebar.tsx`  
**Основной функционал**:
- Универсальное левое меню для всех ролей
- Динамическая фильтрация элементов меню по ролям
- Интеграция с системой токенов для защиты данных
- Адаптивный дизайн с поддержкой мобильных устройств
- Автоматическое обновление токенов

### 2. SidebarLayout.tsx  
**Местоположение**: `client/src/components/layout/SidebarLayout.tsx`  
**Основной функционал**:
- Макет с боковой панелью для страниц дашборда
- Управление состоянием мобильного меню
- Интеграция с контекстом sidebar

### 3. Menu Utilities (menu.ts)
**Местоположение**: `client/src/lib/menu.ts`  
**Функции**: валидация токенов, автоматическое обновление, API интеграция

### 4. SidebarDemo.tsx
**Местоположение**: `client/src/components/SidebarDemo.tsx`  
**Назначение**: Демонстрационная страница для тестирования функциональности

## Функциональность

### ✅ Основные элементы меню
- **Дашборд** - центральная панель управления
- **Профиль пользователя** - настройки аккаунта  
- **Статистика** - аналитика и отчетность
- **Финансы** - платежи и баланс
- **Поддержка** - техническая помощь
- **Выход из системы** - безопасный logout

### ✅ Интеграция с API
- Загрузка данных меню из API endpoint `/api/menu/data`
- Fallback механизм при недоступности API
- Динамическое обновление меню на основе роли пользователя

### ✅ Обработка токенов
- Валидация JWT токенов перед загрузкой меню
- Автоматическое обновление токенов при истечении срока
- Защита элементов меню, требующих авторизации
- Настройка интервалов проверки токенов (каждую минуту)

### ✅ Роль-ориентированные функции
Меню адаптируется под различные роли:

#### Partner/Affiliate
- Офферы, запросы доступа, ссылки
- Статистика, креативы, команда
- Финансы и постбэки (требуют токен)

#### Advertiser  
- Управление офферами и партнёрами
- Отчёты, финансы, антифрод (требуют токен)

#### Owner
- Управление пользователями (требует токен)
- Системные настройки (требует токен)

#### Super Admin
- Полный доступ к системе (требует токен)

### ✅ Адаптивный дизайн
- Полностью адаптивный интерфейс
- Мобильное меню с overlay
- Сворачиваемая боковая панель на десктопе
- Touch-friendly интерфейс для мобильных устройств

## API Endpoints

### GET /api/menu/data
Возвращает данные меню для текущего пользователя:
```json
{
  "items": [...],
  "userRole": "partner",
  "permissions": ["read:offers", "write:links"]
}
```

### POST /api/auth/refresh
Обновляет JWT токен:
```json
{
  "token": "new_jwt_token_here"
}
```

## Интеграция в приложение

### Роутинг
Для использования Universal Sidebar в App.tsx применяется функция `withSidebar`:

```typescript
const withSidebar = (C: React.ComponentType<any>) => function Wrapped() {
  return (
    <SidebarLayout>
      <C />
    </SidebarLayout>
  );
};

// Использование:
<ProtectedRoute 
  path="/dashboard/advertiser" 
  roles={['advertiser']} 
  component={withSidebar(AdvertiserDash)} 
/>
```

### Обновленные маршруты
- **Advertiser**: все роуты `/dashboard/advertiser/*` используют `withSidebar`
- **Partner/Affiliate**: все роуты `/dashboard/affiliate/*` используют `withSidebar` 
- **Demo**: `/sidebar-demo` - демонстрационная страница

## Безопасность

### Токен-зависимые элементы
Следующие элементы меню отображаются только при валидном токене:
- Финансы (для всех ролей)
- Статистика/Аналитика
- Антифрод (для Advertiser)
- Системные настройки (для Owner/Super Admin)

### Валидация токенов
```typescript
export function validateToken(token: string | null): TokenValidationResult {
  // Декодирование JWT
  // Проверка срока действия
  // Возврат статуса валидации
}
```

## Тестирование

### Ручное тестирование
1. **Навигация по Demo**: Посетите `/sidebar-demo` для тестирования функций
2. **Смена ролей**: Проверьте отображение меню для разных ролей
3. **Токены**: Убедитесь в корректной обработке истекших токенов
4. **Мобильный режим**: Протестируйте работу на мобильных устройствах

### Тестовые сценарии
- ✅ Отображение элементов меню для роли Partner
- ✅ Отображение элементов меню для роли Advertiser  
- ✅ Скрытие токен-зависимых элементов при невалидном токене
- ✅ Автоматическое обновление токена
- ✅ Корректная работа мобильного меню
- ✅ Навигация между разделами
- ✅ Выход из системы

## Производительность

### Оптимизации
- Lazy loading компонентов через React.lazy()
- Мемоизация роль-зависимых вычислений
- Эффективная фильтрация элементов меню
- Минимальные ре-рендеры при изменении состояния

### Мониторинг
- Автоматическая проверка токенов каждую минуту
- Fallback на локальную конфигурацию при недоступности API
- Логирование ошибок токенов в консоль

## Поддержка и обновления

### Добавление новых ролей
1. Обновить типы в `auth.ts`
2. Добавить элементы меню в `UniversalSidebar.tsx`
3. Настроить маппинг роли в `getDashboardHref()`

### Новые элементы меню
1. Добавить в массив `menuItems`
2. Настроить роли и требования токена
3. Добавить соответствующий маршрут в `App.tsx`

### API интеграция
1. Реализовать endpoint `/api/menu/data`
2. Обновить интерфейс `MenuData` при необходимости
3. Настроить fallback поведение

## Заключение

Universal Sidebar успешно реализован со всеми требуемыми функциями:
- ✅ Динамическое отображение пунктов меню в зависимости от роли
- ✅ Интеграция с API для получения данных
- ✅ Использование токенов для защиты данных
- ✅ Проверка валидности токенов перед загрузкой
- ✅ Полная поддержка ролей Partner и Advertiser
- ✅ Адаптивный дизайн для всех устройств
- ✅ Автоматическое обновление токенов

Система готова к производственному использованию и легко расширяется для поддержки дополнительных ролей и функций.