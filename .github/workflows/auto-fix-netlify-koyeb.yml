name: Auto-fix Netlify + Koyeb Configuration

on:
  workflow_dispatch:
    inputs:
      koyeb_url:
        description: 'Koyeb API URL (without /api suffix)'
        required: false
        default: 'https://central-matelda-pronto12-95b8129d.koyeb.app'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/auto-fix-netlify-koyeb.yml'
      - 'server/**'
      - 'client/**'

jobs:
  auto-fix-files:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Set variables
      id: vars
      run: |
        KOYEB_URL="${{ github.event.inputs.koyeb_url || 'https://central-matelda-pronto12-95b8129d.koyeb.app' }}"
        echo "koyeb_url=${KOYEB_URL}" >> $GITHUB_OUTPUT
        echo "branch_name=auto-fix/netlify-koyeb-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        
    - name: Create and checkout new branch
      run: |
        git checkout -b ${{ steps.vars.outputs.branch_name }}

    - name: Create/Update netlify.toml
      run: |
        cat > netlify.toml << 'EOF'
        [build]
          command = "npm run build:client"
          publish = "client/dist"

        [build.environment]
          NODE_VERSION = "18"

        [[redirects]]
          from = "/api/*"
          to = "${{ steps.vars.outputs.koyeb_url }}/api/:splat"
          status = 200
          force = true

        [[redirects]]
          from = "/*"
          to = "/index.html"
          status = 200

        # Health check proxy
        [[redirects]]
          from = "/api/health"
          to   = "${{ steps.vars.outputs.koyeb_url }}/health"
          status = 200
          force  = true

        [[headers]]
          for = "/*"
          [headers.values]
            X-Frame-Options = "DENY"
            X-XSS-Protection = "1; mode=block"
            X-Content-Type-Options = "nosniff"
            Referrer-Policy = "strict-origin-when-cross-origin"
            Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https: wss:; object-src 'none'; base-uri 'self'"

        [[headers]]
          for = "*.css"
          [headers.values]
            Cache-Control = "public, max-age=31536000, immutable"

        [[headers]]
          for = "*.js"
          [headers.values]
            Cache-Control = "public, max-age=31536000, immutable"

        [[headers]]
          for = "*.html"
          [headers.values]
            Cache-Control = "public, max-age=3600"

        [[headers]]
          for = "/api/*"
          [headers.values]
            Cache-Control = "no-cache, no-store, must-revalidate"
        EOF

    - name: Create/Update .env.production
      run: |
        cat > .env.production << 'EOF'
        # === PRODUCTION ENVIRONMENT CONFIGURATION ===
        # Auto-generated by GitHub Actions - DO NOT EDIT MANUALLY

        # React App Configuration
        REACT_APP_API_URL=${{ steps.vars.outputs.koyeb_url }}/api

        # Environment
        NODE_ENV=production

        # === DEPLOYMENT INFO ===
        # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        # Koyeb URL: ${{ steps.vars.outputs.koyeb_url }}
        # Branch: ${{ steps.vars.outputs.branch_name }}
        # Commit: ${{ github.sha }}
        EOF

    - name: Check for changes
      id: changes
      run: |
        git add netlify.toml .env.production
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
          git diff --staged --name-only
        fi

    - name: Commit changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git commit -m "ðŸ”§ Auto-fix: Update Netlify + Koyeb configuration

        - Update netlify.toml with Koyeb proxy: ${{ steps.vars.outputs.koyeb_url }}
        - Update .env.production with API URL
        - Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        Auto-generated by GitHub Actions workflow"

    - name: Push branch
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git push origin ${{ steps.vars.outputs.branch_name }}

    - name: Create Pull Request
      if: steps.changes.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ”§ Auto-fix: Update Netlify + Koyeb Configuration',
            head: '${{ steps.vars.outputs.branch_name }}',
            base: 'main',
            body: `## ðŸ¤– ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸

          Ð­Ñ‚Ð¾Ñ‚ PR Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸.

          ### ðŸ“ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:
          - \`netlify.toml\` - ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Netlify Ñ Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð½Ð° Koyeb
          - \`.env.production\` - Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑÑ€ÐµÐ´Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°

          ### ðŸ”— Koyeb Configuration:
          - **API URL**: \`${{ steps.vars.outputs.koyeb_url }}/api\`
          - **Health Check**: \`${{ steps.vars.outputs.koyeb_url }}/health\`

          ### âš™ï¸ Netlify Settings:
          - âœ… API Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð½Ð° Koyeb
          - âœ… SPA routing Ð´Ð»Ñ React Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ  
          - âœ… ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
          - âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ HTTP Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸
          - âœ… CSP Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°

          ### ðŸš€ Deployment Info:
          - **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: ${{ github.sha }}
          - **Workflow**: ${{ github.workflow }}

          ### âœ… Ready to merge!
          ÐŸÐ¾ÑÐ»Ðµ Ð¼ÐµÑ€Ð¶Ð° Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° Netlify.

          ---
          *Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ GitHub Actions*`
          });

          console.log('Pull request created:', pullRequest.html_url);

    - name: Summary
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "## âœ… Auto-fix completed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Updated files:" >> $GITHUB_STEP_SUMMARY
        echo "- \`netlify.toml\` - Netlify configuration with Koyeb proxy" >> $GITHUB_STEP_SUMMARY
        echo "- \`.env.production\` - Production environment variables" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- **Koyeb URL**: \`${{ steps.vars.outputs.koyeb_url }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ steps.vars.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the automatically created Pull Request" >> $GITHUB_STEP_SUMMARY
        echo "2. Merge the PR to apply changes" >> $GITHUB_STEP_SUMMARY
        echo "3. Netlify will automatically deploy with new configuration" >> $GITHUB_STEP_SUMMARY

    - name: No changes summary
      if: steps.changes.outputs.has_changes == 'false'
      run: |
        echo "## â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Configuration files are already up to date." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- \`netlify.toml\` âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- \`.env.production\` âœ…" >> $GITHUB_STEP_SUMMARY