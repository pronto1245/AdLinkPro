# Левое меню AdLinkPro - Документация

## Обзор

В рамках технического задания было реализовано полнофункциональное левое меню для платформы AdLinkPro со всеми требуемыми компонентами: интеграция с API, обработка токенов, роль-ориентированная навигация и адаптивный дизайн.

## Основные компоненты

### 1. UniversalSidebar.tsx
Универсальный компонент левого меню, который работает со всеми ролями пользователей:
- **Местоположение**: `client/src/components/layout/UniversalSidebar.tsx`
- **Функции**: роль-ориентированная навигация, токен-валидация, адаптивный дизайн

### 2. RoleBasedLayout.tsx  
Обновлённый компонент макета с интеграцией левого меню:
- **Местоположение**: `client/src/components/layout/RoleBasedLayout.tsx`
- **Изменения**: заменил горизонтальную навигацию на левое меню

### 3. Menu Utilities (menu.ts)
Утилиты для работы с меню и токенами:
- **Местоположение**: `client/src/lib/menu.ts`
- **Функции**: валидация токенов, автоматическое обновление, API интеграция

## Функциональность

### ✅ Основные элементы меню
- **Дашборд** - центральная панель управления
- **Профиль пользователя** - настройки аккаунта  
- **Настройки** - конфигурация системы
- **Управление ролями** - контроль доступа (для owner/super_admin)
- **Поддержка и документация** - техническая помощь
- **Выход из системы** - безопасный logout

### ✅ Интеграция с API
- Загрузка данных меню из API endpoint `/api/menu/data`
- Fallback механизм при недоступности API
- Динамическое обновление меню на основе роли пользователя

### ✅ Обработка токенов
- JWT токен валидация с парсингом payload
- Автоматическое обновление токенов через `/api/auth/refresh`
- Визуальная индикация статуса токена
- Блокировка защищённых функций при истекшем токене

### ✅ Роль-ориентированные функции
Меню адаптируется под различные роли:

#### Partner/Affiliate
- Офферы, запросы доступа, ссылки
- Статистика, креативы, команда
- Финансы и постбэки (требуют токен)

#### Advertiser  
- Управление офферами и партнёрами
- Отчёты, финансы, антифрод (требуют токен)

#### Owner
- Управление пользователями (требует токен)
- Системные настройки (требует токен)

#### Super Admin
- Управление всеми пользователями (требует токен)
- Системная аналитика (требует токен)  
- Глобальные настройки (требует токен)

### ✅ Адаптивный дизайн
- **Десктоп**: левое меню с возможностью свёртывания (64px ↔ 256px)
- **Мобильные**: overlay меню с кнопкой в верхней панели
- **Анимации**: плавные переходы при свёртывании/развёртывании
- **Темы**: поддержка светлой и тёмной тем

## API Endpoints

### GET /api/menu/data
Возвращает данные меню для текущего пользователя:
```json
{
  "items": [...],
  "userRole": "partner",
  "permissions": ["read:offers", "write:links"]
}
```

### POST /api/auth/refresh
Обновляет JWT токен:
```json
{
  "token": "new_jwt_token_here"
}
```

## Безопасность

### Токен-валидация
- Проверка структуры JWT (3 части)
- Валидация времени истечения
- Автоматическая попытка обновления за 5 минут до истечения

### Контроль доступа
- Элементы меню фильтруются по ролям
- Защищённые функции требуют валидный токен
- Визуальные индикаторы недоступных элементов

### Автоматическое обновление
- Проверка токена каждую минуту
- Фоновое обновление при необходимости
- Graceful fallback при ошибках

## Состояние и контекст

### SidebarContext
- Управление состоянием свёрнутости меню
- Сохранение в localStorage  
- Ширина меню для правильного позиционирования контента

### AuthContext
- Информация о пользователе и токене
- Интеграция с функциями logout

## Установка и использование

### 1. Зависимости
Убедитесь что установлен SidebarProvider в main.tsx:
```tsx
<SidebarProvider>
  <App />
</SidebarProvider>
```

### 2. Использование в компонентах
```tsx
import { withLayout } from './App';

// Автоматически оборачивает компонент в RoleBasedLayout с меню
export default withLayout(YourComponent);
```

### 3. Настройка меню
Измените массив `menuItems` в `UniversalSidebar.tsx` для добавления новых элементов:
```tsx
{
  title: 'Новый элемент',
  href: '/new-path', 
  icon: NewIcon,
  description: 'Описание',
  roles: ['partner'], // Опционально
  requiresToken: true // Опционально
}
```

## Тестирование

### Демо-страница
- **Путь**: `/sidebar-demo.html` (статичная демонстрация)
- **React Route**: `/sidebar-demo` (в приложении)

### Тестирование функций
1. **Свёртывание/развёртывание**: клик на кнопку в заголовке
2. **Мобильная версия**: изменить размер окна < 1024px
3. **Роли**: поменять роль пользователя в токене
4. **Токены**: изменить срок действия токена

## Скриншоты

### Развёрнутое меню
![Развёрнутое меню](https://github.com/user-attachments/assets/a398048b-4813-4ea1-8139-0c5640592579)

### Свёрнутое меню  
![Свёрнутое меню](https://github.com/user-attachments/assets/a6865483-948d-49c2-a264-c9fa95a71e1a)

## Техническая архитектура

### Структура файлов
```
client/src/
├── components/layout/
│   ├── UniversalSidebar.tsx    # Основной компонент меню
│   └── RoleBasedLayout.tsx     # Макет с меню
├── contexts/
│   └── sidebar-context.tsx     # Контекст состояния меню  
├── lib/
│   └── menu.ts                 # Утилиты токенов и API
└── pages/
    └── SidebarDemo.tsx         # Демо-страница
```

### Зависимости
- `@radix-ui/*` - UI компоненты
- `lucide-react` - иконки
- `wouter` - роутинг
- `tailwindcss` - стилизация

## Совместимость

- **React**: 18.x
- **TypeScript**: 5.x  
- **Браузеры**: Chrome 80+, Firefox 75+, Safari 13+
- **Мобильные**: iOS Safari 13+, Chrome Mobile 80+

## Поддержка и обновления

### Добавление новых ролей
1. Обновить типы в `auth.ts`
2. Добавить элементы меню в `UniversalSidebar.tsx`
3. Настроить маппинг роли в `getDashboardHref()`

### Новые элементы меню
1. Добавить в массив `menuItems`
2. Настроить роли и требования токена
3. Добавить соответствующий маршрут в `App.tsx`

### API интеграция
1. Реализовать endpoint `/api/menu/data`
2. Обновить интерфейс `MenuData` при необходимости
3. Настроить fallback поведение